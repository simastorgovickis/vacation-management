generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model AuditLog {
  id           String      @id
  userId       String?
  targetUserId String?
  action       AuditAction
  details      Json
  createdAt    DateTime    @default(now())

  @@index([action])
  @@index([createdAt])
  @@index([targetUserId])
  @@index([userId])
}

model Country {
  id            String          @id
  name          String          @unique
  code          String          @unique
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  PublicHoliday PublicHoliday[]
  User          User[]

  @@index([code])
}

model ManagerEmployee {
  id                                    String   @id
  managerId                             String
  employeeId                            String
  createdAt                             DateTime @default(now())
  User_ManagerEmployee_employeeIdToUser User     @relation("ManagerEmployee_employeeIdToUser", fields: [employeeId], references: [id], onDelete: Cascade)
  User_ManagerEmployee_managerIdToUser  User     @relation("ManagerEmployee_managerIdToUser", fields: [managerId], references: [id], onDelete: Cascade)

  @@unique([managerId, employeeId])
  @@index([employeeId])
  @@index([managerId])
}

model PasswordResetToken {
  id        String   @id
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([token])
  @@index([userId])
}

model PublicHoliday {
  id          String   @id
  countryId   String
  name        String
  date        DateTime
  isRecurring Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  Country     Country  @relation(fields: [countryId], references: [id], onDelete: Cascade)

  @@unique([countryId, name, date])
  @@index([countryId])
  @@index([date])
}

model User {
  id                                               String               @id
  email                                            String               @unique
  name                                             String
  role                                             Role                 @default(EMPLOYEE)
  employmentDate                                   DateTime?
  createdAt                                        DateTime             @default(now())
  updatedAt                                        DateTime
  countryId                                        String?
  ManagerEmployee_ManagerEmployee_employeeIdToUser ManagerEmployee[]    @relation("ManagerEmployee_employeeIdToUser")
  ManagerEmployee_ManagerEmployee_managerIdToUser  ManagerEmployee[]    @relation("ManagerEmployee_managerIdToUser")
  PasswordResetToken                               PasswordResetToken[]
  Country                                          Country?             @relation(fields: [countryId], references: [id])
  VacationAccrualLog                               VacationAccrualLog[]
  VacationBalance                                  VacationBalance[]
  VacationRequest                                  VacationRequest[]

  @@index([countryId])
  @@index([email])
  @@index([role])
}

model VacationAccrualLog {
  id          String   @id
  userId      String
  year        Int
  month       Int
  daysAccrued Float
  createdAt   DateTime @default(now())
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year, month])
  @@index([userId])
  @@index([year, month])
}

model VacationBalance {
  id        String   @id
  userId    String
  year      Int
  accrued   Float    @default(0)
  used      Float    @default(0)
  adjusted  Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year])
  @@index([userId])
  @@index([year])
}

model VacationRequest {
  id              String         @id
  userId          String
  startDate       DateTime
  endDate         DateTime
  days            Float
  status          VacationStatus @default(PENDING)
  comment         String?
  rejectionReason String?
  approvedById    String?
  approvedAt      DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime
  User            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([startDate, endDate])
  @@index([status])
  @@index([userId])
}

enum AuditAction {
  BALANCE_ADJUSTMENT
  USER_CREATED
  USER_UPDATED
  ROLE_CHANGED
  MANAGER_ASSIGNED
}

enum Role {
  ADMIN
  MANAGER
  EMPLOYEE
}

enum VacationStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  CANCELLATION_REQUESTED
}
